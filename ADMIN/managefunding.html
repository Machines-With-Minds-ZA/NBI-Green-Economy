<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Funding - Green Economy Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Funding-Hub.css">
    <link rel="stylesheet" href="../Master Page(Header and Footer)/MasterPage.css">
    <style>
        :root {
            --green-primary: #2b9589;
            --green-dark: #005d6a;
            --green-light: #b8e5e1;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            flex: 1;
        }
        
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            background-color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            background-color: #cbd5e1;
        }
        
        .checkbox-item.selected {
            background-color: var(--green-primary);
            color: white;
        }
        
        .checkbox-item input {
            display: none;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: var(--green-light);
            color: var(--green-dark);
        }
        
        .badge i {
            margin-right: 0.25rem;
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .logo-preview {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border: 1px dashed #ccc;
            border-radius: 0.5rem;
            display: none;
        }
        
        .funding-item {
            transition: all 0.2s;
            border-left: 4px solid var(--green-primary);
        }
        
        .funding-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .filter-option {
            transition: all 0.2s;
        }
        
        .filter-option:hover {
            background-color: #f1f5f9;
        }
        
        .filter-option.selected {
            background-color: var(--green-light);
            color: var(--green-dark);
            font-weight: 500;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background-color: #f1f5f9;
        }
        
        .tab.active {
            background-color: var(--green-primary);
            color: white;
        }
        
        /* Header Styles */
        .header {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .logo {
            height: 50px;
        }
        
        .nav-links {
            display: flex;
            gap: 1.5rem;
        }
        
        .nav-link {
            color: var(--green-dark);
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .nav-link:hover {
            color: var(--green-primary);
        }
        
        
        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .social-link {
            color: white;
            font-size: 1.25rem;
            transition: color 0.2s;
        }
        
        .social-link:hover {
            color: var(--green-light);
        }
        
        .copyright {
            text-align: center;
            padding-top: 2rem;
            margin-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #b8e5e1;
            font-size: 0.875rem;
        }
        
        /* Custom URL input styling */
        .url-input {
            /* Remove default URL validation styling */
            &:invalid {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- Custom Header -->
    <green-economy-dashboard-header></green-economy-dashboard-header>

    <div class="main-content min-h-screen bg-gray-50">
        <!-- Hero Section -->
        <div style="background: linear-gradient(to right, #2b9589, #2b9589);" class="h-64 flex items-center justify-center text-white">
          <div class="text-center px-4">
              <h1 class="text-4xl font-bold mb-4">Manage Funding Opportunities</h1>
              <p class="text-xl">Add, edit, and manage funding opportunities in the database</p>
          </div>
      </div>
      

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-8">
            <!-- Tabs -->
            <div class="flex space-x-2 mb-6 bg-white p-1 rounded-lg shadow-sm">
                <div class="tab active" data-tab="list">List View</div>
                <div class="tab" data-tab="grid">Grid View</div>
            </div>

            <!-- Action Bar -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <!-- Search -->
                <div class="relative w-full md:w-64">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Search funding..." 
                        class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                    >
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                
                <!-- Filters Button -->
                <button id="filter-btn" class="flex items-center px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50">
                    <i class="fas fa-filter mr-2"></i>
                    Filters
                </button>
                
                <!-- Add Funding Button -->
                <button 
    id="add-funding-btn"
    style="background-color: #2b9589;"
    onmouseover="this.style.backgroundColor='#23786f'"
    onmouseout="this.style.backgroundColor='#2b9589'"
    class="text-white px-4 py-2 rounded-lg flex items-center"
>
    <i class="fas fa-plus-circle mr-2"></i>
    Add New Funding
</button>

            </div>

            <!-- Filters Panel -->
            <div id="filters-panel" class="hidden bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Sector Filter -->
                    <div>
                        <h3 class="font-medium mb-2">Sector</h3>
                        <div class="space-y-2">
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="sector" data-value="Energy">
                                <i class="fas fa-bolt mr-2"></i> Energy
                            </div>
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="sector" data-value="Agriculture">
                                <i class="fas fa-tractor mr-2"></i> Agriculture
                            </div>
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="sector" data-value="Climate Finance">
                                <i class="fas fa-cloud-sun mr-2"></i> Climate Finance
                            </div>
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="sector" data-value="Waste">
                                <i class="fas fa-trash mr-2"></i> Waste
                            </div>
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="sector" data-value="Water and Sanitation">
                                <i class="fas fa-tint mr-2"></i> Water & Sanitation
                            </div>
                        </div>
                    </div>
                    
                    <!-- Funding Type Filter -->
                    <div>
                        <h3 class="font-medium mb-2">Funding Type</h3>
                        <div class="space-y-2">
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="type" data-value="Grant">
                                <i class="fas fa-gift mr-2"></i> Grant
                            </div>
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="type" data-value="Debt">
                                <i class="fas fa-hand-holding-usd mr-2"></i> Debt
                            </div>
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="type" data-value="Equity">
                                <i class="fas fa-chart-line mr-2"></i> Equity
                            </div>
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="type" data-value="Working Capital">
                                <i class="fas fa-money-bill-wave mr-2"></i> Working Capital
                            </div>
                        </div>
                    </div>
                    
                    <!-- Target Filter -->
                    <div>
                        <h3 class="font-medium mb-2">Target</h3>
                        <div class="space-y-2">
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="target" data-value="SMMEs">
                                <i class="fas fa-store mr-2"></i> SMME's
                            </div>
                            <div class="filter-option px-3 py-2 rounded cursor-pointer" data-filter="target" data-value="no">
                                <i class="fas fa-building mr-2"></i> Non-SMME's
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end mt-4">
                    <button id="apply-filters" class="bg-green-600 text-white px-4 py-2 rounded-lg mr-2">
                        Apply Filters
                    </button>
                    <button id="clear-filters" class="border border-gray-300 px-4 py-2 rounded-lg">
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Funding List View -->
            <div id="list-view" class="space-y-4">
                <!-- Funding items will be loaded here -->
            </div>

            <!-- Funding Grid View -->
            <div id="grid-view" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Funding cards will be loaded here -->
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-3xl text-green-600"></i>
                <p class="mt-2">Loading funding opportunities...</p>
            </div>

            <!-- No Results -->
            <div id="no-results" class="hidden text-center py-12">
                <i class="fas fa-search text-3xl text-gray-400 mb-4"></i>
                <h3 class="text-xl font-medium text-gray-600">No funding opportunities found</h3>
                <p class="text-gray-500 mt-2">Try adjusting your search or filters</p>
            </div>
        </div>
    </div>

    <!-- Add/Edit Funding Modal -->
    <div id="funding-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl relative max-h-[90vh] overflow-y-auto">
                <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
                
                <div class="p-6">
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">Add New Funding Opportunity</h2>
                    
                    <form id="funding-form" class="space-y-6">
                        <input type="hidden" id="doc-id">
                        
                        <!-- Basic Information Section -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Basic Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700 mb-2">Name of Funding Opportunity*</label>
                                    <input 
                                        type="text" 
                                        id="funding-name" 
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Name of Disbursement Channel*</label>
                                    <input 
                                        type="text" 
                                        id="disbursement-channel" 
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Type of Disbursement Channel*</label>
                                    <input 
                                        type="text" 
                                        id="channel-type" 
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Website URL*</label>
                                    <div class="flex items-center space-x-2">
                                        <input 
                                            type="text" 
                                            id="website" 
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 url-input"
                                            placeholder="www.example.com"
                                            required
                                        >
                                        <button type="button" id="fetch-logo" class="px-3 py-2 bg-gray-100 rounded-lg">
                                            <i class="fas fa-image"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Contact Email</label>
                                    <input 
                                        type="email" 
                                        id="contact-email" 
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    >
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Contact Number</label>
                                    <input 
                                        type="tel" 
                                        id="contact-number" 
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    >
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-gray-700 mb-2">Website Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <img id="logo-preview" src="" class="logo-preview">
                                        <input 
                                            type="text" 
                                            id="logo-url" 
                                            class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                            placeholder="Logo URL or leave blank to auto-fetch"
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Funding Type Section -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Funding Type</h3>
                            <div class="checkbox-container">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="funding-type" value="Grant">
                                    <span><i class="fas fa-gift mr-2"></i> Grant</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="funding-type" value="Debt">
                                    <span><i class="fas fa-hand-holding-usd mr-2"></i> Debt</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="funding-type" value="Equity">
                                    <span><i class="fas fa-chart-line mr-2"></i> Equity</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="funding-type" value="Working Capital">
                                    <span><i class="fas fa-money-bill-wave mr-2"></i> Working Capital</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="funding-type" value="Business Development or Technical Assistance">
                                    <span><i class="fas fa-cogs mr-2"></i> Business Development</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Target Section -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Target</h3>
                            <div class="checkbox-container">
                                <label class="checkbox-item">
                                    <input type="radio" name="target" value="SMMEs">
                                    <span><i class="fas fa-store mr-2"></i> SMME's</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="radio" name="target" value="no">
                                    <span><i class="fas fa-building mr-2"></i> Non-SMME's</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Sector Section -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Sector</h3>
                            <div class="checkbox-container">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="sector" value="Energy">
                                    <span><i class="fas fa-bolt mr-2"></i> Energy</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="sector" value="Agriculture">
                                    <span><i class="fas fa-tractor mr-2"></i> Agriculture</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="sector" value="Climate Finance">
                                    <span><i class="fas fa-cloud-sun mr-2"></i> Climate Finance</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="sector" value="Waste">
                                    <span><i class="fas fa-trash mr-2"></i> Waste</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="sector" value="Water and Sanitation">
                                    <span><i class="fas fa-tint mr-2"></i> Water & Sanitation</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="sector" value="Green Infrastructure">
                                    <span><i class="fas fa-leaf mr-2"></i> Green Infrastructure</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Additional Information -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Additional Information</h3>
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label class="block text-gray-700 mb-2">Focus of Fund</label>
                                    <textarea 
                                        id="focus" 
                                        rows="3" 
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    ></textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-gray-700 mb-2">Key Words</label>
                                        <input 
                                            type="text" 
                                            id="keywords" 
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        >
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Key Words 2</label>
                                        <input 
                                            type="text" 
                                            id="keywords2" 
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        >
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Key Words 3</label>
                                        <input 
                                            type="text" 
                                            id="keywords3" 
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        >
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Ticket Size</label>
                                    <input 
                                        type="text" 
                                        id="ticket-size" 
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    >
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-4">
                            <button 
                                type="button" 
                                id="cancel-btn"
                                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100"
                            >
                                Cancel
                            </button>
                            <button 
                                type="submit" 
                                id="submit-btn"
                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center"
                            >
                                <i class="fas fa-save mr-2"></i>
                                Save Funding Opportunity
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Footer -->

    <green-economy-footer></green-economy-footer>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCfa827mvCLf1ETts6B_DmCfb7owTohBxk",
            authDomain: "nbi-green-economy.firebaseapp.com",
            projectId: "nbi-green-economy",
            storageBucket: "nbi-green-economy.appspot.com",
            messagingSenderId: "53732340059",
            appId: "1:53732340059:web:3fb3f086c6662e1e9baa7e",
            measurementId: "G-37VRZ5CGE4"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // DOM Elements
        const addFundingBtn = document.getElementById('add-funding-btn');
        const fundingModal = document.getElementById('funding-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const fundingForm = document.getElementById('funding-form');
        const fundingList = document.getElementById('list-view');
        const fundingGrid = document.getElementById('grid-view');
        const loadingIndicator = document.getElementById('loading');
        const noResults = document.getElementById('no-results');
        const searchInput = document.getElementById('search-input');
        const filterBtn = document.getElementById('filter-btn');
        const filtersPanel = document.getElementById('filters-panel');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const tabs = document.querySelectorAll('[data-tab]');
        const fetchLogoBtn = document.getElementById('fetch-logo');
        const logoPreview = document.getElementById('logo-preview');
        const logoUrlInput = document.getElementById('logo-url');
        const websiteInput = document.getElementById('website');
        
        // State
        let activeFilters = {
            sector: [],
            type: [],
            target: []
        };
        let allFunding = [];
        
        // Toggle modal
        function toggleModal() {
            fundingModal.classList.toggle('hidden');
        }
        
        // Handle checkbox/radio selection
        document.querySelectorAll('.checkbox-item').forEach(item => {
            item.addEventListener('click', function() {
                const input = this.querySelector('input');
                
                if (input.type === 'radio') {
                    // For radio buttons, unselect all in group first
                    document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                        radio.parentElement.classList.remove('selected');
                    });
                }
                
                // Toggle selected class
                this.classList.toggle('selected');
                
                // For checkboxes, toggle checked state
                if (input.type === 'checkbox') {
                    input.checked = !input.checked;
                } else {
                    // For radios, always set to checked when selected
                    input.checked = true;
                }
            });
        });
        
        // Handle filter selection
        document.querySelectorAll('.filter-option').forEach(option => {
            option.addEventListener('click', function() {
                this.classList.toggle('selected');
            });
        });
        
        // Apply filters
        applyFiltersBtn.addEventListener('click', function() {
            activeFilters = {
                sector: [],
                type: [],
                target: []
            };
            
            // Get selected filters
            document.querySelectorAll('.filter-option.selected').forEach(option => {
                const filterType = option.getAttribute('data-filter');
                const filterValue = option.getAttribute('data-value');
                activeFilters[filterType].push(filterValue);
            });
            
            // Apply filters to data
            filterFunding();
            
            // Close filters panel
            filtersPanel.classList.add('hidden');
        });
        
        // Clear all filters
        clearFiltersBtn.addEventListener('click', function() {
            // Clear selected filters
            document.querySelectorAll('.filter-option.selected').forEach(option => {
                option.classList.remove('selected');
            });
            
            activeFilters = {
                sector: [],
                type: [],
                target: []
            };
            
            // Reset display
            filterFunding();
            
            // Close filters panel
            filtersPanel.classList.add('hidden');
        });
        
        // Filter funding based on active filters and search
        function filterFunding() {
            let filtered = [...allFunding];
            
            // Apply search filter
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(funding => 
                    funding["Name of funding opportunity"]?.toLowerCase().includes(searchTerm) ||
                    funding["Name of disbursment channel"]?.toLowerCase().includes(searchTerm) ||
                    (funding["Focus of Fund"] !== "no" && funding["Focus of Fund"]?.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply sector filter
            if (activeFilters.sector.length > 0) {
                filtered = filtered.filter(funding => 
                    activeFilters.sector.some(sector => funding[sector] !== "no")
                );
            }
            
            // Apply type filter
            if (activeFilters.type.length > 0) {
                filtered = filtered.filter(funding => 
                    activeFilters.type.some(type => funding[type] !== "no")
                );
            }
            
            // Apply target filter
            if (activeFilters.target.length > 0) {
                filtered = filtered.filter(funding => 
                    activeFilters.target.includes(funding.SMMEs)
                );
            }
            
            // Display results
            displayFunding(filtered);
        }
        
        // Display funding in list and grid views
        function displayFunding(fundingArray) {
            if (fundingArray.length === 0) {
                fundingList.innerHTML = '';
                fundingGrid.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            // List View
            fundingList.innerHTML = '';
            fundingArray.forEach(funding => {
                const item = document.createElement('div');
                item.className = 'funding-item bg-white p-4 rounded-lg shadow-sm';
                item.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex items-start space-x-4">
                            ${funding.logo ? `<img src="${funding.logo}" class="w-12 h-12 object-contain rounded-lg">` : '<div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center"><i class="fas fa-link text-gray-400"></i></div>'}
                            <div>
                                <h3 class="font-medium text-lg">${funding["Name of funding opportunity"] || 'No name'}</h3>
                                <h3 class="text-gray-600">${funding["Name of disbursment channel"] || 'No channel'}</h3>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    ${funding.Grant !== "no" ? '<span class="badge"><i class="fas fa-gift"></i> Grant</span>' : ''}
                                    ${funding.Debt !== "no" ? '<span class="badge"><i class="fas fa-hand-holding-usd"></i> Debt</span>' : ''}
                                    ${funding.Equity !== "no" ? '<span class="badge"><i class="fas fa-chart-line"></i> Equity</span>' : ''}
                                    ${funding["Working Capital"] !== "no" ? '<span class="badge"><i class="fas fa-money-bill-wave"></i> Working Capital</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-btn px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200" data-id="${funding.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn px-3 py-1 bg-red-100 text-red-600 rounded-md hover:bg-red-200" data-id="${funding.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${funding["Focus of Fund"] !== "no" ? `<p class="mt-3 text-gray-700">${funding["Focus of Fund"]}</p>` : ''}
                `;
                fundingList.appendChild(item);
            });
            
            // Grid View
            fundingGrid.innerHTML = '';
            fundingArray.forEach(funding => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md overflow-hidden';
                card.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium">${funding["Name of funding opportunity"] || 'No name'}</h3>
                                <p class="text-gray-600 text-sm">${funding["Name of disbursment channel"] || 'No channel'}</p>
                            </div>
                            ${funding.logo ? `<img src="${funding.logo}" class="w-12 h-12 object-contain rounded-lg">` : '<div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center"><i class="fas fa-link text-gray-400"></i></div>'}
                        </div>
                        
                        ${funding["Focus of Fund"] !== "no" ? `<p class="mt-3 text-gray-700 text-sm">${funding["Focus of Fund"]}</p>` : ''}
                        
                        <div class="flex flex-wrap gap-2 mt-4">
                            ${funding.Grant !== "no" ? '<span class="badge"><i class="fas fa-gift"></i> Grant</span>' : ''}
                            ${funding.Debt !== "no" ? '<span class="badge"><i class="fas fa-hand-holding-usd"></i> Debt</span>' : ''}
                            ${funding.Equity !== "no" ? '<span class="badge"><i class="fas fa-chart-line"></i> Equity</span>' : ''}
                            ${funding["Working Capital"] !== "no" ? '<span class="badge"><i class="fas fa-money-bill-wave"></i> Working Capital</span>' : ''}
                        </div>
                        
                        <div class="flex justify-end space-x-2 mt-4">
                            <button class="edit-btn px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200" data-id="${funding.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn px-3 py-1 bg-red-100 text-red-600 rounded-md hover:bg-red-200" data-id="${funding.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                fundingGrid.appendChild(card);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    editFundingOpportunity(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    deleteFundingOpportunity(id);
                });
            });
        }
        
        // Fetch website logo using Clearbit API
        async function fetchWebsiteLogo(url) {
            try {
                // Add https:// if not present
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                
                // Extract domain from URL
                let domain = url.replace(/^(https?:\/\/)?(www\.)?/, '').split('/')[0];
                
                // Try Clearbit API
                const clearbitUrl = `https://logo.clearbit.com/${domain}?size=128`;
                
                // Check if the logo exists
                const response = await fetch(clearbitUrl, { method: 'HEAD' });
                if (response.ok) {
                    return clearbitUrl;
                }
                
                // Fallback to Favicon API
                const faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
                return faviconUrl;
            } catch (error) {
                console.error("Error fetching logo:", error);
                return null;
            }
        }
        
        // Load funding opportunities
        async function loadFundingOpportunities() {
            try {
                loadingIndicator.classList.remove('hidden');
                const querySnapshot = await db.collection("funding").get();
                allFunding = [];
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    allFunding.push(data);
                });
                
                // Try to get logos for each funding
                const logoPromises = allFunding.map(async (funding) => {
                    if (funding.Website && funding.Website !== "no") {
                        try {
                            const logoUrl = await fetchWebsiteLogo(funding.Website);
                            if (logoUrl) {
                                funding.logo = logoUrl;
                            }
                        } catch (error) {
                            console.error("Error getting logo for", funding["Name of funding opportunity"], error);
                        }
                    }
                    return funding;
                });
                
                // Wait for all logo fetches to complete
                allFunding = await Promise.all(logoPromises);
                
                // Display all funding initially
                filterFunding();
                loadingIndicator.classList.add('hidden');
            } catch (error) {
                console.error("Error loading funding opportunities: ", error);
                loadingIndicator.classList.add('hidden');
                alert('Error loading funding opportunities. Please try again.');
            }
        }
        
        // Edit funding opportunity
        async function editFundingOpportunity(id) {
            try {
                const docRef = db.collection("funding").doc(id);
                const docSnap = await docRef.get();
                
                if (docSnap.exists) {
                    const data = docSnap.data();
                    
                    // Fill the form with existing data
                    document.getElementById('doc-id').value = id;
                    document.getElementById('funding-name').value = data["Name of funding opportunity"] || '';
                    document.getElementById('disbursement-channel').value = data["Name of disbursment channel"] || '';
                    document.getElementById('channel-type').value = data["Type of Disbursement Channel"] || '';
                    
                    // Display website URL as is (without http/https if it wasn't stored with it)
                    let websiteUrl = data.Website || '';
                    if (websiteUrl.startsWith('http://')) {
                        websiteUrl = websiteUrl.substring(7);
                    } else if (websiteUrl.startsWith('https://')) {
                        websiteUrl = websiteUrl.substring(8);
                    }
                    document.getElementById('website').value = websiteUrl;
                    
                    document.getElementById('contact-email').value = data["Contact Email"] !== "no" ? data["Contact Email"] : "";
                    document.getElementById('contact-number').value = data["Contact Number"] !== "no" ? data["Contact Number"] : "";
                    document.getElementById('focus').value = data["Focus of Fund"] !== "no" ? data["Focus of Fund"] : "";
                    document.getElementById('keywords').value = data["Key Words"] !== "no" ? data["Key Words"] : "";
                    document.getElementById('keywords2').value = data["Key Words2"] !== "no" ? data["Key Words2"] : "";
                    document.getElementById('keywords3').value = data["Key Words3"] !== "no" ? data["Key Words3"] : "";
                    document.getElementById('ticket-size').value = data["Ticket Size"] !== "no" ? data["Ticket Size"] : "";
                    document.getElementById('logo-url').value = data.logo || "";
                    
                    // Show logo preview if available
                    if (data.logo) {
                        logoPreview.src = data.logo;
                        logoPreview.style.display = 'block';
                    } else {
                        logoPreview.style.display = 'none';
                    }
                    
                    // Set target - ensure proper highlighting
                    const targetRadios = document.querySelectorAll('input[name="target"]');
                    targetRadios.forEach(radio => {
                        radio.checked = false;
                        radio.parentElement.classList.remove('selected');
                    });
                    
                    if (data.SMMEs === "SMMEs") {
                        const smmeRadio = document.querySelector('input[name="target"][value="SMMEs"]');
                        if (smmeRadio) {
                            smmeRadio.checked = true;
                            smmeRadio.parentElement.classList.add('selected');
                        }
                    } else {
                        const nonSmmeRadio = document.querySelector('input[name="target"][value="no"]');
                        if (nonSmmeRadio) {
                            nonSmmeRadio.checked = true;
                            nonSmmeRadio.parentElement.classList.add('selected');
                        }
                    }
                    
                    // Set funding types - ensure proper highlighting
                    const fundingTypes = ["Grant", "Debt", "Equity", "Working Capital", "Business Development or Technical Assistance"];
                    const fundingCheckboxes = document.querySelectorAll('input[name="funding-type"]');
                    fundingCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                        checkbox.parentElement.classList.remove('selected');
                    });
                    
                    fundingTypes.forEach(type => {
                        if (data[type] !== "no") {
                            const checkbox = document.querySelector(`input[name="funding-type"][value="${type}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                checkbox.parentElement.classList.add('selected');
                            }
                        }
                    });
                    
                    // Set sectors - ensure proper highlighting
                    const sectors = ["Energy", "Agriculture", "Climate Finance", "Waste", "Water and Sanitation", "Green Infrastructure"];
                    const sectorCheckboxes = document.querySelectorAll('input[name="sector"]');
                    sectorCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                        checkbox.parentElement.classList.remove('selected');
                    });
                    
                    sectors.forEach(sector => {
                        if (data[sector] !== "no") {
                            const checkbox = document.querySelector(`input[name="sector"][value="${sector}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                checkbox.parentElement.classList.add('selected');
                            }
                        }
                    });
                    
                    // Change modal title and submit button
                    document.getElementById('modal-title').textContent = 'Edit Funding Opportunity';
                    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i> Update Funding Opportunity';
                    
                    // Show the modal
                    toggleModal();
                }
            } catch (error) {
                console.error("Error getting document: ", error);
                alert('Error loading funding opportunity. Please try again.');
            }
        }
        
        // Delete funding opportunity
        async function deleteFundingOpportunity(id) {
            if (confirm('Are you sure you want to delete this funding opportunity?')) {
                try {
                    await db.collection("funding").doc(id).delete();
                    loadFundingOpportunities();
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert('Error deleting funding opportunity. Please try again.');
                }
            }
        }
        
        // Form submission
        fundingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            let websiteUrl = document.getElementById('website').value;
            // Add http:// if not present
            if (websiteUrl && !websiteUrl.startsWith('http://') && !websiteUrl.startsWith('https://')) {
                websiteUrl = 'https://' + websiteUrl;
            }
            
            const fundingData = {
                "Name of funding opportunity": document.getElementById('funding-name').value,
                "Name of disbursment channel": document.getElementById('disbursement-channel').value,
                "Type of Disbursement Channel": document.getElementById('channel-type').value,
                "Website": websiteUrl || "no",
                "Contact Email": document.getElementById('contact-email').value || "no",
                "Contact Number": document.getElementById('contact-number').value || "no",
                "Focus of Fund": document.getElementById('focus').value || "no",
                "Key Words": document.getElementById('keywords').value || "no",
                "Key Words2": document.getElementById('keywords2').value || "no",
                "Key Words3": document.getElementById('keywords3').value || "no",
                "Ticket Size": document.getElementById('ticket-size').value || "no",
                "Key": "no",
                "SMMEs": document.querySelector('input[name="target"]:checked')?.value || "no",
                "Business Development or Technical Assistance": "no",
                "Climate Finance": "no",
                "Energy": "no",
                "Agriculture": "no",
                "Waste": "no",
                "Water and Sanitation": "no",
                "Green Infrastructure": "no",
                "Grant": "no",
                "Debt": "no",
                "Equity": "no",
                "Working Capital": "no"
            };
            
            // Add logo if available
            const logoUrl = document.getElementById('logo-url').value;
            if (logoUrl) {
                fundingData.logo = logoUrl;
            }
            
            // Process funding types
            document.querySelectorAll('input[name="funding-type"]:checked').forEach(checkbox => {
                if (checkbox.value === "Business Development or Technical Assistance") {
                    fundingData["Business Development or Technical Assistance"] = checkbox.value;
                } else {
                    fundingData[checkbox.value] = checkbox.value;
                }
            });
            
            // Process sectors
            document.querySelectorAll('input[name="sector"]:checked').forEach(checkbox => {
                fundingData[checkbox.value] = checkbox.value;
            });
            
            try {
                const docId = document.getElementById('doc-id').value;
                
                if (docId) {
                    // Update existing document
                    await db.collection("funding").doc(docId).update(fundingData);
                } else {
                    // Add new document
                    await db.collection("funding").add(fundingData);
                }
                
                // Show success message
                alert(`Funding opportunity ${docId ? 'updated' : 'added'} successfully!`);
                
                // Reset form and close modal
                fundingForm.reset();
                logoPreview.style.display = 'none';
                toggleModal();
                
                // Refresh funding list
                loadFundingOpportunities();
            } catch (error) {
                console.error("Error saving document: ", error);
                alert('Error saving funding opportunity. Please try again.');
            }
        });
        
        // Fetch logo button
        fetchLogoBtn.addEventListener('click', async function() {
            let websiteUrl = document.getElementById('website').value;
            if (!websiteUrl) {
                alert('Please enter a website URL first');
                return;
            }
            
            // Add https:// if not present
            if (!websiteUrl.startsWith('http://') && !websiteUrl.startsWith('https://')) {
                websiteUrl = 'https://' + websiteUrl;
            }
            
            try {
                const logoUrl = await fetchWebsiteLogo(websiteUrl);
                if (logoUrl) {
                    logoPreview.src = logoUrl;
                    logoPreview.style.display = 'block';
                    document.getElementById('logo-url').value = logoUrl;
                } else {
                    alert('Could not find a logo for this website');
                }
            } catch (error) {
                console.error("Error fetching logo:", error);
                alert('Error fetching logo. Please try again or enter a URL manually.');
            }
        });
        
        // Toggle filters panel
        filterBtn.addEventListener('click', function() {
            filtersPanel.classList.toggle('hidden');
        });
        
        // Search functionality
        searchInput.addEventListener('input', function() {
            filterFunding();
        });
        
        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                if (this.getAttribute('data-tab') === 'list') {
                    fundingList.classList.remove('hidden');
                    fundingGrid.classList.add('hidden');
                } else {
                    fundingList.classList.add('hidden');
                    fundingGrid.classList.remove('hidden');
                }
            });
        });
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            loadFundingOpportunities();
            
            // Event listeners for modal
            addFundingBtn.addEventListener('click', function() {
                // Reset form
                fundingForm.reset();
                document.getElementById('doc-id').value = '';
                logoPreview.style.display = 'none';
                
                // Change modal title and submit button
                document.getElementById('modal-title').textContent = 'Add New Funding Opportunity';
                document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i> Save Funding Opportunity';
                
                // Clear all checkbox selections
                document.querySelectorAll('.checkbox-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                document.querySelectorAll('.checkbox-item input').forEach(input => {
                    input.checked = false;
                });
                
                toggleModal();
            });
            
            closeModalBtn.addEventListener('click', toggleModal);
            cancelBtn.addEventListener('click', toggleModal);
            
            // Custom URL validation - allow any input
            websiteInput.addEventListener('input', function() {
                this.setCustomValidity('');
            });
        });
    </script>
    <script src="../Master Page(Header and Footer)/MasterPage.js"></script>
    <script src="../Master Page(Header and Footer)/translation.js"></script>
    <script src="../scripts/Funding-Hub.js"></script>
</body>
</html>