<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Management | NBI Green Economy</title>
  <link rel="stylesheet" href="../../Master Page(Header and Footer)/MasterPage.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="../../Master Page(Header and Footer)/MasterPage.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      color: #333;
      background-color: #f8f9fa;
    }

    .container {
      width: 95%;
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 15px;
    }

    header {
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo img {
      height: 50px;
    }

    .logo-text {
      font-weight: 700;
      font-size: 1.5rem;
    }

    .dashboard {
      padding: 30px 0;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .dashboard-title {
      font-size: 2rem;
      font-weight: 700;
      color: #2b9589;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      border: none;
    }

    .btn-primary {
      background-color: #2b9589;
      color: white;
    }

    .btn-primary:hover {
      background-color: #4ec3b0;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .search-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 200px;
    }

    .search-input:focus {
      outline: none;
      border-color: #2b9589;
      box-shadow: 0 0 5px rgba(43, 149, 137, 0.3);
    }

    .category-selector {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    .category-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .category-tab {
      padding: 10px 20px;
      background: #f1f1f1;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .category-tab:hover {
      background: #e0e0e0;
    }

    .category-tab.active {
      background: #2b9589;
      color: white;
    }

    .data-table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      overflow-x: auto;
      border: 1px solid #2b9589;
    }

    .data-table {
      width: 100%;
      min-width: 2000px;
      border-collapse: separate;
      border-spacing: 0;
    }

    .data-table th, 
    .data-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
      border-right: 1px solid #eee;
    }

    .data-table th {
      background-color: #f8f6f0;
      font-weight: 600;
      position: sticky;
      top: 0;
      color: #333;
      border-bottom: 2px solid #2b9589;
    }

    .data-table th:last-child, 
    .data-table td:last-child {
      border-right: none;
    }

    .data-table tr:hover {
      background-color: rgba(43, 149, 137, 0.05);
    }

    .loading-indicator {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2b9589;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }

    .page-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }

    .page-btn.active {
      background-color: #2b9589;
      color: white;
      border-color: #2b9589;
    }

    .page-btn:hover:not(.active) {
      background-color: #f1f1f1;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      width: 95%;
      max-width: 1200px;
      max-height: 90vh;
      padding: 20px;
      position: relative;
      transform: translateY(-20px);
      transition: transform 0.3s;
      overflow-y: auto;
      border: 2px solid #2b9589;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }

    .modal-title {
      font-size: 1.5rem;
      color: #000;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #666;
      transition: color 0.3s;
    }

    .modal-close:hover {
      color: #2b9589;
    }

    .modal-body {
      padding: 10px 0;
    }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-section h3 {
      color: #2b9589;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .detail-item {
      margin-bottom: 10px;
    }

    .detail-label {
      font-weight: 600;
      color: #555;
      margin-bottom: 3px;
    }

    .detail-value {
      padding: 5px;
      background: #f8f8f8;
      border-radius: 4px;
    }

    @media (max-width: 1200px) {
      .data-table-container {
        overflow-x: auto;
      }
      
      .data-table {
        min-width: 2000px;
      }
    }

    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .action-buttons {
        width: 100%;
        justify-content: flex-end;
      }
      
      .category-tabs {
        overflow-x: auto;
        padding-bottom: 10px;
        flex-wrap: nowrap;
      }
      
      .modal-content {
        width: 98%;
        max-height: 85vh;
      }
    }

    @media (max-width: 576px) {
      .btn {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      .modal-content {
        width: 100%;
        max-height: 80vh;
        padding: 15px;
      }
      
      .detail-grid {
        grid-template-columns: 1fr;
      }
      
      .search-input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <green-economy-header></green-economy-header>

  <section class="dashboard">
    <div class="container">
      <div class="dashboard-header">
        <h1 class="dashboard-title">Project Database Management</h1>
        <div class="action-buttons" id="actionButtons">
          <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Search projects...">
          </div>
          <input type="file" id="excelUpload" accept=".xlsx" style="display: none;">
          <button id="uploadBtn" class="btn btn-primary">
            <i class="bi bi-upload"></i> Upload Excel
          </button>
          <button id="exportBtn" class="btn btn-primary">
            <i class="bi bi-download"></i> Export Data
          </button>
          <button id="refreshBtn" class="btn btn-secondary">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>

      <div class="category-selector">
        <h3>Select Data Categories to Display</h3>
        <div class="category-tabs" id="categoryTabs"></div>
      </div>

      <div class="data-table-container">
        <div id="loadingIndicator" class="loading-indicator">
          <div class="spinner"></div>
          <p>Loading project data...</p>
        </div>
        
        <table class="data-table">
          <thead id="tableHeader"></thead>
          <tbody id="tableBody"></tbody>
        </table>
        
        <div id="noResults" class="no-results" style="display: none;">
          No projects found matching your criteria.
        </div>
      </div>

      <div class="pagination" id="pagination"></div>
    </div>
  </section>

  <div class="modal-overlay" id="projectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Project Details</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body" id="projectDetails"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc, writeBatch, getDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCfa827mvCLf1ETts6B_DmCfb7owTohBxk",
      authDomain: "nbi-green-economy.firebaseapp.com",
      projectId: "nbi-green-economy",
      storageBucket: "nbi-green-economy.firebasestorage.app",
      messagingSenderId: "53732340059",
      appId: "1:53732340059:web:3fb3f086c6662e1e9baa7e",
      measurementId: "G-37VRZ5CGE4"
    };

    // Initialize Firebase
    try {
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      console.log('Firebase initialized successfully');

      // Column categories based on provided CSV columns
      const columnCategories = {
        "Project Information": [
          "Project Code", "Project Name", "Programme Start", "Programme End", 
          "TVET College", "Project Status", "GIZ Enrollment Number", 
          "GIZ Enrollment Date", "Type of support / programme"
        ],
        "Beneficiary Details": [
          "Identity / Passport Number", "First Name/s", "Surname", "Date of Birth", 
          "Age", "Gender", "Ethnicity", "Nationality", "Disability", "Disability Type"
        ],
        "Contact Information": [
          "Residential Address", "Township/Rural Location", "Province", 
          "Local Municipality", "District Municipality", "Postal code", 
          "Cell Number", "WhatsApp Number (if applicable)", "Email Address", 
          "Preferred contact method", "IRM Platform Notifications"
        ],
        "Education & Employment": [
          "Education Level", "Highest educational qualification attained", 
          "Name of Highest educational qualification attained", "Year Obtained", 
          "Employment Status", "Position in Company/ Job Title"
        ],
        "Business Ownership": [
          "Business Ownership Interest", "Number of Other Business Owners", 
          "Secondary Business Contact First Name/s", "Secondary Business Contact Surname", 
          "Secondary Business Contact Surname", "Secondary Business Contact Cell Number"
        ],
        "Business Details": [
          "Business Name", "Business Operating Start Date", "Years in Business", 
          "Legal Type of business entity", "Business Core Products and Services", 
          "Business Registration status", "Business Registration number", 
          "Business date of registration", "Business Financial Year-End", 
          "Copy of CIPC registration certificate"
        ],
        "Tax & Compliance": [
          "Business Tax Registration Status", "Business Income Tax reference number", 
          "Tax compliance PIN expiry date", "Copy of Tax clearance certificate", 
          "Business Website Address"
        ],
        "Business Location": [
          "Business Address", "Type of Business Premises", "Township/Rural Location", 
          "Province", "Local Municipality", "Ward Number", "District Municipality", 
          "Postal code", "TVET College nearest to the business location"
        ],
        "Financial & BBBEE": [
          "Business Annual Revenue (Last Financial Year-End)", "BBBEE Classification", 
          "BBBEE Level of Contribution", "Copy of BBBEE certificate / Affidavit", 
          "BBBEE certificate / Affidavit expiry date", "Black Ownership and Management Control", 
          "Black Female Ownership", "Black Youth Ownership", "Disabled Ownership"
        ],
        "Market & Workforce": [
          "Main Market/Revenue Source", "Type of Main Market/Revenue Source", 
          "Market Geographic Reach", "Total Number of Employees", 
          "Total Number of Female Employees", "Total Number of Youth Employees", 
          "Total Number of Black Employees"
        ],
        "Training & Development": [
          "Does the business have a history of Hosting Learners/Apprentices", 
          "Name of the last Organization that provided the Learners/Apprentices", 
          "Total number of Learners/Apprentices hosted", "Hosting period", 
          "Does the business have an interest and capacity to Host Learners/Apprentices", 
          "Total number of Learners/Apprentices the business wants to host", 
          "Hosting period"
        ],
        "Enterprise Development": [
          "Does the business have a history of Enterprise Development", 
          "Name of the last Organization that provided Enterprise Development", 
          "Enterprise Development period", "Received Enterprise Development Support", 
          "Type of Access to Finance Received", "Name of the Organization that Provided the Finance", 
          "Value of Finance Received"
        ]
      };

      // DOM Elements
      const categoryTabs = document.getElementById('categoryTabs');
      const tableHeader = document.getElementById('tableHeader');
      const tableBody = document.getElementById('tableBody');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const noResults = document.getElementById('noResults');
      const pagination = document.getElementById('pagination');
      const projectModal = document.getElementById('projectModal');
      const closeModal = document.getElementById('closeModal');
      const projectDetails = document.getElementById('projectDetails');
      const exportBtn = document.getElementById('exportBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const uploadBtn = document.getElementById('uploadBtn');
      const excelUpload = document.getElementById('excelUpload');
      const searchInput = document.getElementById('searchInput');

      // Global variables
      let currentColumns = ["Project Code", "Project Name", "TVET College", "Project Status"];
      let currentPage = 1;
      const projectsPerPage = 10;
      let allProjects = [];
      let filteredProjects = [];

      // Check if initial upload is complete
      async function isUploadComplete() {
        const uploadStatusDoc = await getDoc(doc(db, 'metadata', 'uploadStatus'));
        return uploadStatusDoc.exists() && uploadStatusDoc.data().completed === true;
      }

      // Set upload complete status
      async function setUploadComplete() {
        await setDoc(doc(db, 'metadata', 'uploadStatus'), { completed: true });
      }

      // Check if Firestore collection has data
      async function hasDataInFirestore() {
        const snapshot = await getDocs(collection(db, 'projects'));
        console.log('Firestore projects count:', snapshot.size);
        return !snapshot.empty;
      }

      // Initialize the dashboard
      document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM loaded, initializing dashboard');
        const uploadCompleted = await isUploadComplete();
        const hasData = await hasDataInFirestore();
        if (uploadCompleted || hasData) {
          console.log('Data exists or upload completed, hiding upload button');
          uploadBtn.style.display = 'none';
          excelUpload.style.display = 'none';
        }

        initCategoryTabs();
        loadProjects();

        // Event listeners
        closeModal.addEventListener('click', () => projectModal.classList.remove('active'));
        exportBtn.addEventListener('click', exportData);
        refreshBtn.addEventListener('click', refreshData);
        uploadBtn.addEventListener('click', () => excelUpload.click());
        excelUpload.addEventListener('change', handleExcelUpload);
        searchInput.addEventListener('input', handleSearch);

        projectModal.addEventListener('click', (e) => {
          if (e.target === projectModal) projectModal.classList.remove('active');
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && projectModal.classList.contains('active')) {
            projectModal.classList.remove('active');
          }
        });
      });

      // Handle search input
      function handleSearch() {
        const query = searchInput.value.toLowerCase().trim();
        console.log('Searching for:', query);
        if (query === '') {
          filteredProjects = [...allProjects];
        } else {
          filteredProjects = allProjects.filter(project => {
            return (
              (project["Project Code"] && project["Project Code"].toLowerCase().includes(query)) ||
              (project["Project Name"] && project["Project Name"].toLowerCase().includes(query)) ||
              (project["TVET College"] && project["TVET College"].toLowerCase().includes(query)) ||
              (project["Project Status"] && project["Project Status"].toLowerCase().includes(query)) ||
              (project["First Name/s"] && project["First Name/s"].toLowerCase().includes(query)) ||
              (project["Surname"] && project["Surname"].toLowerCase().includes(query))
            );
          });
        }
        currentPage = 1;
        displayProjects();
      }

      // Handle Excel file upload
      async function handleExcelUpload(event) {
        console.log('Excel upload initiated');
        const file = event.target.files[0];
        if (!file) {
          console.log('No file selected');
          alert('Please select an Excel file.');
          return;
        }

        loadingIndicator.style.display = 'block';

        const hasData = await hasDataInFirestore();
        if (hasData) {
          const overwrite = confirm('Data already exists in the database. Do you want to overwrite it with this Excel file?');
          if (!overwrite) {
            console.log('User cancelled overwrite');
            loadingIndicator.style.display = 'none';
            excelUpload.value = '';
            return;
          }
          console.log('Clearing existing data for overwrite');
          const snapshot = await getDocs(collection(db, 'projects'));
          const batch = writeBatch(db);
          snapshot.docs.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            console.log('Reading Excel file');
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            console.log('Sheet name:', sheetName);
            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            if (jsonData.length < 1) {
              throw new Error('Excel file is empty');
            }

            // Normalize headers to handle whitespace and variations
            const headers = jsonData[0].map(header => header ? header.toString().trim().replace(/\s+/g, ' ') : '');
            console.log('Headers:', headers);

            // Find Project Code column, with fallbacks
            let projectCodeIndex = headers.indexOf('Project Code');
            if (projectCodeIndex === -1) {
              projectCodeIndex = headers.indexOf('New project name');
            }
            if (projectCodeIndex === -1) {
              projectCodeIndex = headers.indexOf('Oroginal Project name');
            }
            if (projectCodeIndex === -1) {
              throw new Error('Could not find "Project Code", "New project name", or "Oroginal Project name" in headers');
            }
            console.log('Project Code column index:', projectCodeIndex, 'Header:', headers[projectCodeIndex]);

            const rows = jsonData.slice(1);
            if (rows.length === 0) {
              throw new Error('No data rows found in Excel file');
            }

            const batch = writeBatch(db);
            const projectsRef = collection(db, 'projects');
            let validRows = 0;
            let generatedIds = [];

            // Handle duplicate headers
            const headerCount = {};
            headers.forEach((header, i) => {
              if (headerCount[header]) {
                headerCount[header]++;
                headers[i] = `${header}_${headerCount[header]}`;
              } else {
                headerCount[header] = 1;
              }
            });

            rows.forEach((row, index) => {
              const rowData = {};
              headers.forEach((header, i) => {
                rowData[header] = row[i] !== undefined ? row[i].toString().trim() : '';
              });

              if (index < 3) {
                console.log(`Row ${index + 2} data:`, rowData);
              }

              let projectCode = row[projectCodeIndex];
              if (!projectCode || projectCode.toString().trim() === '') {
                projectCode = `gen_${index}_${Math.random().toString(36).substr(2, 5)}`;
                console.log(`Row ${index + 2}: No valid Project Code, using generated ID: ${projectCode}`);
                rowData[headers[projectCodeIndex]] = projectCode;
                generatedIds.push(`Row ${index + 2}: ${projectCode}`);
              }

              const docRef = doc(projectsRef, projectCode.toString());
              batch.set(docRef, rowData);
              validRows++;
            });

            console.log(`Uploading ${validRows} rows to Firestore`);
            if (generatedIds.length > 0) {
              console.log('Rows with generated IDs:', generatedIds);
              alert(`Uploaded ${validRows} rows. ${generatedIds.length} rows had missing Project Codes and were assigned generated IDs.\nDetails in console.`);
            } else {
              alert(`Successfully uploaded ${validRows} rows to Firebase!`);
            }

            await batch.commit();
            await setUploadComplete();
            uploadBtn.style.display = 'none';
            excelUpload.style.display = 'none';
            console.log('Upload button hidden');
            refreshData();
          } catch (error) {
            console.error('Error uploading Excel:', error);
            alert('Error uploading Excel: ' + error.message);
          } finally {
            loadingIndicator.style.display = 'none';
            excelUpload.value = '';
          }
        };
        reader.onerror = () => {
          console.error('Error reading file');
          alert('Error reading Excel file');
          loadingIndicator.style.display = 'none';
        };
        reader.readAsArrayBuffer(file);
      }

      // Initialize category tabs
      function initCategoryTabs() {
        console.log('Initializing category tabs');
        for (const category in columnCategories) {
          const tab = document.createElement('div');
          tab.className = 'category-tab';
          if (category === "Project Information") tab.classList.add('active');
          tab.textContent = category;
          tab.dataset.category = category;
          tab.addEventListener('click', toggleCategory);
          categoryTabs.appendChild(tab);
        }
      }

      // Toggle category visibility
      function toggleCategory(e) {
        console.log('Toggling category:', e.target.dataset.category);
        const category = e.target.dataset.category;
        e.target.classList.toggle('active');

        if (e.target.classList.contains('active')) {
          columnCategories[category].forEach(col => {
            if (!currentColumns.includes(col)) currentColumns.push(col);
          });
        } else {
          currentColumns = currentColumns.filter(col => !columnCategories[category].includes(col));
        }

        if (!currentColumns.includes("Project Code")) currentColumns.unshift("Project Code");

        displayProjects();
      }

      // Load projects from Firestore
      async function loadProjects() {
        console.log('Loading projects from Firestore');
        loadingIndicator.style.display = 'block';
        try {
          const snapshot = await getDocs(collection(db, 'projects'));
          allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          filteredProjects = [...allProjects];
          console.log('Projects loaded:', filteredProjects.length);
          displayProjects();
        } catch (error) {
          console.error('Error loading projects:', error);
          alert('Error loading projects: ' + error.message);
        } finally {
          loadingIndicator.style.display = 'none';
        }
      }

      // Refresh data
      function refreshData() {
        console.log('Refreshing data');
        loadingIndicator.style.display = 'block';
        tableBody.innerHTML = '';
        searchInput.value = '';
        loadProjects();
      }

      // Display projects in the table
      function displayProjects() {
        console.log('Displaying projects:', filteredProjects.length);
        updateTableHeader();
        tableBody.innerHTML = '';

        if (filteredProjects.length === 0) {
          console.log('No projects to display');
          noResults.style.display = 'block';
          pagination.innerHTML = '';
          return;
        }

        noResults.style.display = 'none';

        const totalPages = Math.ceil(filteredProjects.length / projectsPerPage);
        const startIndex = (currentPage - 1) * projectsPerPage;
        const endIndex = Math.min(startIndex + projectsPerPage, filteredProjects.length);
        const paginatedProjects = filteredProjects.slice(startIndex, endIndex);

        paginatedProjects.forEach(project => {
          const row = document.createElement('tr');

          currentColumns.forEach(column => {
            const cell = document.createElement('td');
            cell.textContent = project[column] || '-';
            row.appendChild(cell);
          });

          const actionCell = document.createElement('td');
          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn btn-primary';
          viewBtn.style.padding = '5px 10px';
          viewBtn.innerHTML = '<i class="bi bi-eye"></i> View';
          viewBtn.addEventListener('click', () => viewProjectDetails(project["Project Code"] || project["New project name"] || project["Oroginal Project name"]));
          actionCell.appendChild(viewBtn);
          row.appendChild(actionCell);

          tableBody.appendChild(row);
        });

        generatePagination(totalPages);
      }

      // Update table header
      function updateTableHeader() {
        console.log('Updating table header with columns:', currentColumns);
        tableHeader.innerHTML = '';
        const headerRow = document.createElement('tr');

        currentColumns.forEach(column => {
          const th = document.createElement('th');
          th.textContent = column;
          headerRow.appendChild(th);
        });

        const actionTh = document.createElement('th');
        actionTh.textContent = 'Actions';
        headerRow.appendChild(actionTh);

        tableHeader.appendChild(headerRow);
      }

      // View project details in modal
      function viewProjectDetails(projectCode) {
        console.log('Viewing project details for:', projectCode);
        const project = filteredProjects.find(p => 
          p["Project Code"] === projectCode || 
          p["New project name"] === projectCode || 
          p["Oroginal Project name"] === projectCode
        );
        if (!project) {
          console.log('Project not found:', projectCode);
          return;
        }

        let detailsHTML = '';

        for (const category in columnCategories) {
          const categoryColumns = columnCategories[category];
          let hasData = false;

          for (const col of categoryColumns) {
            if (project[col]) {
              hasData = true;
              break;
            }
          }

          if (!hasData) continue;

          detailsHTML += `
            <div class="detail-section">
              <h3>${category}</h3>
              <div class="detail-grid">
          `;

          categoryColumns.forEach(col => {
            if (project[col]) {
              detailsHTML += `
                <div class="detail-item">
                  <div class="detail-label">${col}</div>
                  <div class="detail-value">${project[col]}</div>
                </div>
              `;
            }
          });

          detailsHTML += `</div></div>`;
        }

        projectDetails.innerHTML = detailsHTML;
        projectModal.classList.add('active');
      }

      // Generate pagination controls
      function generatePagination(totalPages) {
        console.log('Generating pagination for', totalPages, 'pages');
        pagination.innerHTML = '';

        if (totalPages <= 1) return;

        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerHTML = '&laquo;';
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            displayProjects();
          }
        });
        pagination.appendChild(prevBtn);

        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (startPage > 1) {
          const firstPageBtn = document.createElement('button');
          firstPageBtn.className = 'page-btn';
          firstPageBtn.textContent = '1';
          firstPageBtn.addEventListener('click', () => {
            currentPage = 1;
            displayProjects();
          });
          pagination.appendChild(firstPageBtn);

          if (startPage > 2) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.padding = '8px 12px';
            pagination.appendChild(ellipsis);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
          pageBtn.textContent = i;
          pageBtn.addEventListener('click', () => {
            currentPage = i;
            displayProjects();
          });
          pagination.appendChild(pageBtn);
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.padding = '8px 12px';
            pagination.appendChild(ellipsis);
          }

          const lastPageBtn = document.createElement('button');
          lastPageBtn.className = 'page-btn';
          lastPageBtn.textContent = totalPages;
          lastPageBtn.addEventListener('click', () => {
            currentPage = totalPages;
            displayProjects();
          });
          pagination.appendChild(lastPageBtn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerHTML = '&raquo;';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', () => {
          if (currentPage < totalPages) {
            currentPage++;
            displayProjects();
          }
        });
        pagination.appendChild(nextBtn);
      }

      // Export data to CSV
      function exportData() {
        console.log('Exporting data');
        if (filteredProjects.length === 0) {
          alert('No data to export');
          return;
        }

        let csvContent = currentColumns.join(',') + ',Actions\n';

        filteredProjects.forEach(project => {
          const row = currentColumns.map(col => {
            let value = project[col] || '';
            if (typeof value === 'string' && value.includes(',')) {
              return `"${value.replace(/"/g, '""')}"`;
            }
            return value;
          });
          csvContent += row.join(',') + '\n';
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `nbi_projects_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      alert('Failed to initialize Firebase: ' + error.message);
    }
  </script>
</body>
</html>