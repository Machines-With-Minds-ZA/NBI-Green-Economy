<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Green Economy Opportunities</title>
    <link rel="stylesheet" href="../../Master Page(Header and Footer)/MasterPage.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../../Master Page(Header and Footer)/MasterPage.js"></script>
    <script src="../Master Page(Header and Footer)/translation.js"></script>
    <script src="https://unpkg.com/i18next@22/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend@2.2.0/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@7.0.1/i18nextBrowserLanguageDetector.min.js"></script>
    <link rel="stylesheet" href="Opportunities.css">
    <script src="Trans.js"></script>
    <style>
      /* Additional styles for pagination that match existing design */
      .pagination .page-item.active .page-link {
        background-color: #2b9589;
        border-color: #2b9589;
        color: white;
      }
      .pagination .page-link {
        color: #2b9589;
      }
      .pagination .page-item.disabled .page-link {
        color: #6c757d;
      }
      /* Loading spinner */
      #loadingSpinner {
        display: none;
        margin: 40px auto;
        color: #2b9589;
      }
      /* No results message */
      #noResults {
        display: none;
        text-align: center;
        padding: 40px 0;
      }
      #noResults i {
        font-size: 3rem;
        color: #adb5bd;
        margin-bottom: 15px;
      }
      #noResults h4 {
        color: #495057;
        margin-bottom: 10px;
      }
      #noResults p {
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <green-economy-header></green-economy-header>

    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-content">
        <div class="hero-image-section">
          <img src="https://images.pexels.com/photos/30733226/pexels-photo-30733226.jpeg" alt="Hero Image" class="hero-img" />
        </div>
        <div class="hero-text">
          <h1>Opportunities</h1>
          <p>
           Find out about opportunities for procurement, market access, capacity building, training and enterprise development support in your area.
          </p>
          <p>
            This page is your go-to hub for all the information you need, right at your fingertips. Use the filter to select resources tailored to your specific category of interest.
          </p>
        </div>
      </div>
    </section>

    <!-- Opportunities Info and Filter Section -->
    <section class="py-5 bg-light">
      <div class="mx-auto" style="max-width: 1600px; width: 90%;">
        
        <div class="row mb-4 align-items-center g-3">
          <div class="col-md-3">
            <select class="form-select" id="categoryFilter">
              <option value="" data-i18n="filter.default">Filter by Category</option>
              <option value="procurement" data-i18n="filter.procurement">Procurement</option>
              <option value="market-access" data-i18n="filter.marketAccess">Market Access</option>
              <option value="capacity-building" data-i18n="filter.capacityBuilding">Capacity Building</option>
              <option value="training" data-i18n="filter.training">Training</option>
              <option value="enterprise-development" data-i18n="filter.enterpriseDevelopment">Enterprise Development</option>
            </select>
          </div>
          <div class="col-md-3 offset-md-6 d-flex justify-content-end align-items-center">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="Search..." data-i18n="[placeholder]filter.searchPlaceholder">
              <button type="button" class="btn btn-green" id="resetSearch" data-i18n="filter.reset">Reset</button>
            </div>
          </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        
        <!-- Opportunity Cards Grid -->
        <div id="opportunity-cards" class="row gx-4 gy-4 w-100 mx-0"></div>
        
        <!-- No Results Message -->
        <div id="noResults">
          <i class="bi bi-search"></i>
          <h4>No opportunities found</h4>
          <p>Try adjusting your search or filters</p>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Opportunity pagination" class="d-flex justify-content-center mt-5">
          <ul class="pagination" id="pagination">
            <!-- Pagination buttons will be rendered here by JS -->
          </ul>
        </nav>
      </div>
    </section>

    <!-- Logos Section -->
    <section class="partners">
      <div class="partners-content">
        <img src="../../Images/giz-logo_2024-11-11-133203_nara.jpg" alt="Partner Logo 1" class="partner-logo">
        <img src="../../Images/SECO-Logo.jpg" alt="Partner Logo 2" class="partner-logo">
        <img src="../../Images/GDED-Logo.jpg" alt="Partner Logo 3" class="partner-logo">
        <img src="../../Images/LMS-Platform-Logo.png" alt="Partner Logo 4" class="partner-logo">
        <img src="../../Images/NBI-Logo.jpg" alt="Partner Logo 5" class="partner-logo">
      </div>
    </section>

    <!-- Newsletter Subscription Section -->
    <section class="login-section">
      <div style="position: relative; max-width: 700px; margin: 0 auto;">
        <h2 style="color: white; font-size: 20px; margin-bottom: 25px; max-width: 600px; margin-left: auto; margin-right: auto;">
          Subscribe to our newsletter to get the latest information
        </h2>
        <form style="position: relative;">
          <input 
            type="email" 
            placeholder="Your email" 
            style="width: 100%; padding: 18px 50px 18px 25px; border: none; border-radius: 4px; font-size: 16px; color: #333; background: white;"
          >
          <button 
            type="submit" 
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 22px; color: #009381; cursor: pointer;"
          >
            â†’
          </button>
        </form>
      </div>
      <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 15px; max-width: 700px; margin-left: auto; margin-right: auto;">
        *Only relevant information, no spam
      </p>
    </section>

    <!-- Footer -->
    <green-economy-footer></green-economy-footer>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCfa827mvCLf1ETts6B_DmCfb7owTohBxk",
        authDomain: "nbi-green-economy.firebaseapp.com",
        projectId: "nbi-green-economy",
        storageBucket: "nbi-green-economy.appspot.com",
        messagingSenderId: "53732340059",
        appId: "1:53732340059:web:3fb3f086c6662e1e9baa7e",
        measurementId: "G-37VRZ5CGE4"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const opportunitiesRef = db.collection("opportunities");

      // DOM Elements
      const opportunityCards = document.getElementById('opportunity-cards');
      const pagination = document.getElementById('pagination');
      const categoryFilter = document.getElementById('categoryFilter');
      const searchInput = document.getElementById('searchInput');
      const resetSearch = document.getElementById('resetSearch');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const noResults = document.getElementById('noResults');

      // State
      let allOpportunities = [];
      let filteredOpportunities = [];
      const itemsPerPage = 8;
      let currentPage = 1;

      // Load opportunities from Firestore
      function loadOpportunities() {
        loadingSpinner.style.display = 'block';
        opportunityCards.innerHTML = '';
        noResults.style.display = 'none';
        
        opportunitiesRef.orderBy("createdAt", "desc").get()
          .then((querySnapshot) => {
            allOpportunities = [];
            querySnapshot.forEach((doc) => {
              allOpportunities.push({
                id: doc.id,
                ...doc.data()
              });
            });
            filterOpportunities();
            loadingSpinner.style.display = 'none';
          })
          .catch((error) => {
            console.error("Error getting opportunities: ", error);
            loadingSpinner.style.display = 'none';
            alert('Error loading opportunities. Please try again.');
          });
      }

      // Filter opportunities based on category and search
      function filterOpportunities() {
        const category = categoryFilter.value;
        const searchTerm = searchInput.value.toLowerCase();
        
        filteredOpportunities = allOpportunities.filter(opportunity => {
          const matchesCategory = !category || opportunity.category === category;
          const matchesSearch = !searchTerm || 
            opportunity.name.toLowerCase().includes(searchTerm) || 
            opportunity.description.toLowerCase().includes(searchTerm);
          return matchesCategory && matchesSearch;
        });
        
        currentPage = 1;
        renderOpportunities();
        renderPagination();
      }

      // Render opportunities for current page
      function renderOpportunities() {
        opportunityCards.innerHTML = '';
        
        if (filteredOpportunities.length === 0) {
          noResults.style.display = 'block';
          return;
        } else {
          noResults.style.display = 'none';
        }
        
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedOpportunities = filteredOpportunities.slice(startIndex, endIndex);
        
        paginatedOpportunities.forEach(opportunity => {
          const opportunityCard = document.createElement('div');
          opportunityCard.className = 'col-md-6 col-lg-4 col-xl-3';
          opportunityCard.innerHTML = `
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">${opportunity.name}</h5>
                <p class="card-text">${opportunity.description.substring(0, 150)}${opportunity.description.length > 150 ? '...' : ''}</p>
              </div>
              <div class="card-footer bg-transparent">
                ${opportunity.link ? 
                  `<a href="${opportunity.link}" target="_blank" class="btn btn-green btn-sm">
                    ${opportunity.linkText || 'View Details'}
                  </a>` : 
                  '<span class="text-muted">No link available</span>'}
              </div>
            </div>
          `;
          opportunityCards.appendChild(opportunityCard);
        });
      }

      // Render pagination buttons
      function renderPagination() {
        pagination.innerHTML = '';
        const totalPages = Math.ceil(filteredOpportunities.length / itemsPerPage);
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
        prevLi.addEventListener('click', (e) => {
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            renderOpportunities();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
        pagination.appendChild(prevLi);
        
        // Page buttons
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        if (startPage > 1) {
          const firstLi = document.createElement('li');
          firstLi.className = 'page-item';
          firstLi.innerHTML = `<a class="page-link" href="#">1</a>`;
          firstLi.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = 1;
            renderOpportunities();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
          pagination.appendChild(firstLi);
          
          if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            pagination.appendChild(ellipsisLi);
          }
        }
        
        for (let i = startPage; i <= endPage; i++) {
          const pageLi = document.createElement('li');
          pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
          pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          pageLi.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = i;
            renderOpportunities();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
          pagination.appendChild(pageLi);
        }
        
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            pagination.appendChild(ellipsisLi);
          }
          
          const lastLi = document.createElement('li');
          lastLi.className = 'page-item';
          lastLi.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
          lastLi.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = totalPages;
            renderOpportunities();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
          pagination.appendChild(lastLi);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
        nextLi.addEventListener('click', (e) => {
          e.preventDefault();
          if (currentPage < totalPages) {
            currentPage++;
            renderOpportunities();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
        pagination.appendChild(nextLi);
      }

      // Event listeners
      categoryFilter.addEventListener('change', filterOpportunities);
      searchInput.addEventListener('input', filterOpportunities);
      resetSearch.addEventListener('click', () => {
        categoryFilter.value = '';
        searchInput.value = '';
        filterOpportunities();
      });

      // Initialize the page
      document.addEventListener('DOMContentLoaded', loadOpportunities);

      // Video and other existing functionality
      document.querySelectorAll('.business-card-button').forEach((button) => {
        button.addEventListener('click', function () {
          alert('Feature coming soon!');
        });
      });
      document.querySelector('.dashboard-button').addEventListener('click', function () {
        window.location.href = "questionnaire/questionnaire.html";
      });

      // Video Overlay functionality
      document.addEventListener('DOMContentLoaded', function() {
        const pulsingIcon = document.querySelector('.pulsing-icon');
        const videoOverlay = document.querySelector('.video-overlay');
        const closeVideo = document.querySelector('.close-video');
        const floatingVideo = document.getElementById('floatingVideo');
        const langButtons = document.querySelectorAll('.lang-btn');
        
        const videoSources = {
          'eng': '../../Videos/OpportunitiesPage_Eng.mp4',
          'zulu': '../../Videos/OpportunitiesPage_Zulu.mp4',
          'tswana': '../../Videos/OpportunitiesPage_Tswana.mp4'
        };
        
        let currentLang = 'eng';
        
        pulsingIcon.addEventListener('click', function(e) {
          e.preventDefault();
          videoOverlay.classList.toggle('active');
          
          if (videoOverlay.classList.contains('active')) {
            playCurrentVideo();
            pulsingIcon.style.opacity = '0.7';
          } else {
            floatingVideo.pause();
            pulsingIcon.style.opacity = '1';
          }
        });
        
        closeVideo.addEventListener('click', function(e) {
          e.stopPropagation();
          closeVideoPlayer();
        });
        
        videoOverlay.addEventListener('click', function(e) {
          if (e.target === videoOverlay) {
            closeVideoPlayer();
          }
        });
        
        langButtons.forEach(button => {
          button.addEventListener('click', function(e) {
            e.stopPropagation();
            const lang = this.getAttribute('data-lang');
            if (lang !== currentLang) {
              langButtons.forEach(btn => btn.classList.remove('active'));
              this.classList.add('active');
              
              currentLang = lang;
              playCurrentVideo();
            }
          });
        });
        
        floatingVideo.addEventListener('ended', function() {
          closeVideoPlayer();
        });
        
        function playCurrentVideo() {
          const source = videoSources[currentLang];
          if (source) {
            const currentTime = floatingVideo.currentTime;
            floatingVideo.src = source;
            floatingVideo.load();
            floatingVideo.currentTime = currentTime;
            floatingVideo.play().catch(e => console.log('Video play failed:', e));
            
            floatingVideo.addEventListener('canplaythrough', function onCanPlay() {
              floatingVideo.play().catch(e => console.log('Video auto-play failed:', e));
              floatingVideo.removeEventListener('canplaythrough', onCanPlay);
            });
          }
        }
        
        function closeVideoPlayer() {
          videoOverlay.classList.remove('active');
          floatingVideo.pause();
          pulsingIcon.style.opacity = '1';
        }
        
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && videoOverlay.classList.contains('active')) {
            closeVideoPlayer();
          }
        });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>